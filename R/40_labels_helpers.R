# ============================================================
# Labels helpers (TSV codelists)
# - Eurostat SDMX 2.1 codelist endpoint returns TSV without header
# - We set colnames ourselves and return a standard (code, label) df
# ============================================================

download_codelist_tsv <- function(dim, lang = "en", agency = "ESTAT") {
  url <- sprintf(
    "https://ec.europa.eu/eurostat/api/dissemination/sdmx/2.1/codelist/%s/%s?format=TSV&lang=%s",
    agency, toupper(dim), lang
  )
  
  tf <- tempfile(fileext = ".tsv")
  utils::download.file(url, tf, quiet = TRUE, mode = "wb")
  
  # No header in these files:
  # Usually 2 columns: code \t label
  # Sometimes there can be extra columns; we keep first two.
  x <- utils::read.delim(
    tf,
    header = FALSE,
    sep = "\t",
    quote = "",
    stringsAsFactors = FALSE,
    check.names = FALSE,
    fileEncoding = "UTF-8"
  )
  
  if (ncol(x) < 2) {
    stop("Codelist TSV for ", dim, " has <2 columns. URL: ", url)
  }
  
  x <- x[, 1:2, drop = FALSE]
  names(x) <- c("code", "label")
  x
}

download_codelists_tsv <- function(dims, lang = "en", agency = "ESTAT") {
  out <- vector("list", length(dims))
  names(out) <- dims
  for (d in dims) {
    out[[d]] <- tryCatch(
      download_codelist_tsv(d, lang = lang, agency = agency),
      error = function(e) {
        message("Codelist download failed for dim=", d, " : ", conditionMessage(e))
        NULL
      }
    )
  }
  out
}

add_labels_to_data <- function(df, codelists) {
  for (d in names(codelists)) {
    if (!d %in% names(df)) next
    lu <- codelists[[d]]
    if (is.null(lu) || nrow(lu) == 0) next
    
    names(lu) <- c("code", paste0(d, "_label"))
    df <- merge(df, lu, by.x = d, by.y = "code", all.x = TRUE, sort = FALSE)
  }
  df
}

# Generates ready-to-paste R helper code for another project
build_labels_helper_code <- function(dims, lang = "en", agency = "ESTAT") {
  dims_chr <- paste(sprintf('"%s"', dims), collapse = ", ")
  
  paste0(
    '## --- Labels helper (generated by Eurostat Dataset Explorer) ---
## Purpose:
## - Download codelists (code + label) for the dataset dimensions
## - Merge labels onto your SDMX-CSV data frame (no local files needed)

download_codelist_tsv <- function(dim, lang = "', lang, '", agency = "', agency, '") {
  url <- sprintf(
    "https://ec.europa.eu/eurostat/api/dissemination/sdmx/2.1/codelist/%s/%s?format=TSV&lang=%s",
    agency, toupper(dim), lang
  )
  tf <- tempfile(fileext = ".tsv")
  utils::download.file(url, tf, quiet = TRUE, mode = "wb")
  x <- utils::read.delim(tf, header = FALSE, sep = "\\t", quote = "",
                         stringsAsFactors = FALSE, check.names = FALSE, fileEncoding = "UTF-8")
  x <- x[, 1:2, drop = FALSE]
  names(x) <- c("code", "label")
  x
}

download_codelists_tsv <- function(dims, lang = "', lang, '", agency = "', agency, '") {
  out <- vector("list", length(dims)); names(out) <- dims
  for (d in dims) out[[d]] <- tryCatch(download_codelist_tsv(d, lang, agency), error = function(e) NULL)
  out
}

add_labels_to_data <- function(df, codelists) {
  for (d in names(codelists)) {
    if (!d %in% names(df)) next
    lu <- codelists[[d]]
    if (is.null(lu) || nrow(lu) == 0) next
    names(lu) <- c("code", paste0(d, "_label"))
    df <- merge(df, lu, by.x = d, by.y = "code", all.x = TRUE, sort = FALSE)
  }
  df
}

## ---- Usage ----
dims <- c(', dims_chr, ')
codelists <- download_codelists_tsv(dims, lang = "', lang, '")

## df <- read.csv("your_downloaded_sdmx.csv", stringsAsFactors = FALSE, check.names = FALSE)
## df_labeled <- add_labels_to_data(df, codelists)
## head(df_labeled)
'
  )
}
